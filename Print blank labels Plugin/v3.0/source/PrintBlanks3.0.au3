#Region ;**** Directives created by AutoIt3Wrapper_GUI ****
#AutoIt3Wrapper_Icon=ZebraPrinterIcon.ico
#AutoIt3Wrapper_Res_Description=Print Rock Labels using a Zebra Printer
#AutoIt3Wrapper_Res_Fileversion=3.0.0.0
#AutoIt3Wrapper_Res_Fileversion_AutoIncrement=p
#AutoIt3Wrapper_Res_LegalCopyright=Copyright 2022 Michael Garrison
#AutoIt3Wrapper_Res_Language=1033
#EndRegion ;**** Directives created by AutoIt3Wrapper_GUI ****

; Compiled using AutoIt v3.3.16.0

#include <WinHTTP.au3>
#include <Json.au3>
#include <GUIScrollbars_Ex.au3>
#include <GuiOnChangeRegister.au3>

#include <GUIConstantsEx.au3>
#include <ListviewConstants.au3>
#include <EditConstants.au3>
#include <ButtonConstants.au3>
#include <WindowsConstants.au3>
#include <StaticConstants.au3>

#include <GuiListView.au3>
#include <GDIPlus.au3>
#include <Array.au3>


#cs
Discarded idea:

Provide save/open functions for multiple sets of labels
- I was thinking of "Open" and "Save" (which was essentially save as).
  But I think people would want a "quick save" which would mean I'd
  need to track the current file name and whether it was currently
  saved, which also means deleting autosave if it's currently saved,
  and then if there's an autosave asking them if they want to open
  when the program launches. Too much overhead for minimal gain.

  Just start from where they left off and call it good :)
#ce


Global Const $iPreviewImgWidth = 406
Global Const $iPreviewImgHeight = 203
Global Const $darkBackgroundColor = 0xDCDCDC
Global Const $sFilePath_Settings = @ScriptDir & "\PrintBlankLabelSettings.ini"
Global Const $sFilePath_LabelSave = @ScriptDir & "\autosave.dat"

Global $hGui_ScrollingMergeFields
Global $sHttpReturnHeaders
Global $aMergeFieldControls; set a dummy attribute so syntax checker is happy (actual array is initialized in the following line)
InitializeMergeFieldControlsArray()

#Region; IconFont
Global Const $DefaultIconFont =	"~DUE:ROC000,20268,00010000000B0080000300304F532F321238112F000000BC00000060636D6170009100990000011C0000004C67617370000000100000016800000008676C7966149D82B1000001700000490C6865616411CB8B1A00004A7C000000366868656108C2052300004AB400000024686D7478741C03FB00004AD8000001886C6F636196F7852000004C60000000C66D617870006B011A00004D28000000206E616D6586DEE98000004D48000001C2706F73740003000000004F0C00000020000303E0019000050000029902CC0000008F029902CC000001EB00330109000000000000000000000000000000010000000000000000000000000000000000400000007E03C0FFC0004003C00040000000010000000003A7032700000020000000000003000000030000001C000100030000001C000300010000001C00040030000000080008000200000001007EFFFDFFFF000000000020FFFDFFFF0001FFE300030001000000000000000000010001FFFF000F00010000000000000000000200003739010000000001000000000000000000020000373901000000000100000000000000000002000037390100000000020000FFB7038003B70023002D000001233534262B0122061D01213534262B0122061D01232206151114163321323635113426032122263511211114060320600E0A500A0EFF000E0A500A0E602838382802C028383834FD58050702C0070337680A0E0E0A68680A0E0E0A683828FD402838382802C02838FCE007050254FDAC05070000040000FFB7038003B700190029003900440000251134262321220615111416332132363D013426272634373E01013436332132161D0114062321222635153436332132161D0114062321222635012122263534363321061403801C14FD704F7170500290141C0A080606080AFD80070501A805070705FE580507070501A805070705FE58050701FBFDC51B25261A023B03E702A0141C714FFD8050701C14200B1406176817061401CF05070705280507070558050707052805070705FE34251B1A261A4C00000000040020FFB702E003B700170029003F005A000025151406071514062B0122263D012E013D013436332132160134363332363534262322061514163332361332171E01171615140607232E013534373E013736333522070E010706151416171E013B013236373E013534272E0127260220120E1C14A0141C0E120E0A01100A0EFEE04B350D13130D4F71130D0D1380352F2E4614146141BC42601414462E2F35494040601B1C7B3A05190FFC0F19053A7B1C1B6040405F3810180513141C1C1413051810380A0E0E01EE354B130D0D13714F0D1313010D1414462E2F35753695953675352F2E461414601C1B604040499951970E11110E975199494040601" & _
								"B1C00070000FFF704800377001C002800340040004C0058006C00001722262F012E013534373E0137363332171E011716151406070E01232101220615141633323635342601323635342623220615141601220615141633323635342613220615141633323635342621220615141633323635342607260607030E0115141633323635342627133626971B2D0C011F232D2E9C6969777769699C2E2D231F0D2D1BFCAE03691B25251B1B2525FE251B25251B1B2525FE5B1B25251B1B2525681A26261A1B2525025F1B25251B1A2626C81324065C31454B35354B19155C0612091C16013C88497769699C2E2D2D2E9C69697749883C171C0180261A1B25251B1A260140251B1A26261A1B25FEC0261A1B25251B1A26013D261A1B25251B1A26261A1B25251B1A263F061313FEE1034A32354B4B351E3311011F132400000000010000FFB7050003B70055000001233534262321353332363511342623212206151114163B01152122061D012322061511141633213236351134262B013521152322061511141633213236351134262B0135211523220615111416332132363511342604D0602F21FE9060141C1C14FEE0141C1C1460FE90212F60141C1C140120141C1C1460016060141C1C140120141C1C1460016060141C1C140120141C1C013760212F501C140120141C1C14FEE0141C502F21601C14FEE0141C1C140120141C50501C14FEE0141C1C140120141C50501C14FEE0141C1C140120141C0000020000FFB7034003B7003B004E00000114171E011716151406071316062B01222637132E013534373E013736353632171116323736373E0137363536321714171E01171617163237113632130306163B013236351134262322070E01171601A006050B05054C3E1A011C1580151C011A3E4C05050B0506055704021D01010302060202055605020206020301011D020457F31E021D1570141C1C143E48484C11120398031F1F522A2A1A4F6C16FE23141E1E1401DD166D4E1A2A2A521F1F031F21FEE60505132E2E602526012020022525602E2E130505011A21FDA6FE8E151F1C1403A0141C3C3BB46A6900040000FFF704000377000D0011001B0025000017211123353426232122061D012337211521051114062B011133321601232226351134363B01C00280403828FEC0283840C00100FF000280382820202838FC802028383828200902C0602838382860404060FE00283802C038FD78382802002838000000000200000000036E036E0034006700000130141506070E0107062322272E01272627070E0123222635113436332132161514060F011E01333236373E01373E013B0132161513111406232122263534363F012E01232206070E01070E012B0122263D0136373E0137363332171E01171617373E0133321615035F1228276F" & _
								"46454F2A29294C23241E4A050D070F16160F01000F1506054E2868374C85280A0D070209066E080A0F160FFF000F1505054F2868374C85280B0C0802080771080B1327287046464F2A29294D23241E4A060D070F16015B03014B403F5B191908081F17161D4A0505150F01000F16160F070D064E26294B4110211206070B0801CAFF000F16160F070D054F26284A4111211106070B07044C403F5A1A1908091F16171C490506150F0000000100000000036E036E004D000001111406232122262726363F012E012322070E0107061514171E011716333236373E013732161F0116140706070E0107062322272E0127263534373E0137363332171E01171617373E01171E0115036E160FFF000B12050404084F2867383D353550171717175035353D44792A0207040407034E0604202626572F2F315B505077222323227750505B2A29294E23231E4A08160A0A0D0325FF000F160D0A0A16074F252917174F35363C3D35355017173C3603030103024F050E06251E1D290A0B23227750505B5B4F5078222309081F16171C4908050504120B00030000FFF704000377003C0062006E000001233E0135380139013426232206070E010715310E012B012E012B012206151114163B013236373332163B013236373E01273E01373533323635342623152316140716060716062B01222627113E01373E01373E013332161514061521321615140623011406232226353436333216035AAD0203635544381C0B1B0E171B0A0608170D801B25251B800D1708062B795A2B5D69011311040508034844626343B6131D1014160A333C2B446C40263818111F0E15230E233535013D1B2B2A1CFD561C14141C1C14141C02A40A160C485F702E12210F011A1507092218FE331722080850674F1B422109160C0162444463ED16491B1E410C3B404A050162042F1C132716234D1F28343E1A2B1C1C2AFF00141C1C14141C1C00020000FFB7048003B70021002500000121220615111416332107232206151416332132363534262B012721323635113426032111210420FC402838382801802090141C1C140220141C1C149020018028383848FC80038003B73828FD802838601C14141C1C14141C60382802802838FD40024000020010FFC703F003A7001B003700000122070E0107061514171E0117163332373E0137363534272E0127260322272E0127263534373E0137363332171E0117161514070E0107060200675A5A8727272727875A5A67675A5A8727272727875A5A675349496C201F1F206C4949535349496C201F1F206C494903A72727875A5A67675A5B8627272727865B5A67675A5A872727FC801F206C4949535349486D1F20201F6D4849535349496C201F00000000020000FFC4048003B7004100510000013426273534262306070E0107062321220" & _
								"61D0114163B01061514161716171E01171E01373E01272E01373E01353426273126363716171E0117161732363D013E010726272E012726273536373E013736370480241C4B35313637834F4F61FEC028383828570F0F0C0D0C030A071F76271809121C1C10010102021922305848487A33332E354B1C24C0292F306E40404A4A40406E302F2901F71F310AE6354B2A2D2E4B18183828C02838312C2C52272726080D051406100A33121B3B24020502040703255D1006191A492B2A284B35E50A32F92222213A1515098C0915153A2122220000030000FFF703800377000F0013002800000121220615111416332132363511342603211121070106222F0126343F0136321F010136321F0116140320FD402838382802C028383828FD4002C048FEA7071407B507072D07140778011A0714072D0703773828FD402838382802C02838FCE002C0DDFEAA0707B70714072D070779011907072E07140002003CFFB702F303B70031003D00000122070E0107060706161F011636373E01333216151406070E011D0114163B0132363D0134373E0137363534272E0127262303220615141633323635342601943C32325324231E0B060F5610270C26453A2F5B342E356F1C1490141C28275E27271F1F643F3E40143952523939525203B70C0C2F22212C10260C410C050F2F34372C222B1A1E5A5D13141C1C140B2115163D313157413839521718FD15513A395151393A5100000000080000FFB7038003B7002300330043005300630073008300930000012122263D0134363B013534363B0132161D01213534363B0132161D013332161D011406052132161511140623212226351134361334262B0122061D0114163B013236351134262B0122061D0114163B013236350534262B0122061D0114163B013236351134262B0122061D0114163B013236350534262B0122061D0114163B013236351134262B0122061D0114163B013236350368FCB00A0E3828600E0A500A0E01000E0A500A0E6028380EFCA603500A0E3828FD4028380EF20E0A500A0E0E0A500A0E0E0A500A0E0E0A500A0E01000E0A500A0E0E0A500A0E0E0A500A0E0E0A500A0E01000E0A500A0E0E0A500A0E0E0A500A0E0E0A500A0E02770E0A482838680A0E0E0A68680A0E0E0A683828480A0E400E0AFDF82838382802080A0EFE680A0E0E0A500A0E0E0A01500A0E0E0A500A0E0E0AB00A0E0E0A500A0E0E0A01500A0E0E0A500A0E0E0AB00A0E0E0A500A0E0E0A01500A0E0E0A500A0E0E0A00010001FFB7040003B6002D0000012726060F010E0115141617311706070E01070607272E012322060731070E011F011E013332373E01373635342603DBD0111F076002020909791B25255A34353B6307130B050A04E010100430041A11C0A9A9FC494915038630041010E0040A050B14" & _
								"06633A34345B25251C79080A020260071F11D010154949FBA9AAC0111A000000020000FFF703800377000F004A0000012122061511141633213236351134260122262F0126343534363731373E0133321617311736373E01373637272E013534363731373E013332163331171E01153801390114070E010706230320FD402838382802C0283838FD740B10021E010A088C030603070C043E252121381717114C050601013C040F09020302820A0D2E2D9E696A7803773828FD402838382802C02838FD000D0A82020302090F033C020106054C111817382121243E040C070306038C080A011E02110A786A6A9D2E2D000100000037040003370011000001212721220615111416332132363511342603A0FE8080FEC028383828034028383802B7803828FDC02838382801C02838000002000000370400033700110029000001212721220615111416332132363511342603212226351134363338013121172132161531111406233103A0FE8080FEC028383828034028383834FCD805070705010C80019C0507070502B7803828FDC02838382801C02838FDE0070502280507800705FE5805070002000000370479033700160026000001070E01233801312122263F013E01333801312132160725213534262321272122061511373E01047990113B23FCE01C1B0E90113B2303201C1B0EFCB702903828FEC080FEC028388A1A59016FF91C233018F81D23301888602838803828FDD4ED2C3300000300000037047103370017002E003200000123353426232127212206151114163321323637311336262521172132161531152122060715071134363338013901012113210420603828FEC080FEC02838382803201A2A0DA01E37FC14010C80015C0507FDD01A2B0D7E07050314FD109A02F601F7602838803828FDC02838181501003063E080070554191501D001D30507FDC00100000000020026FFD303DA039B00780084000001171E01070E01070E012322262731270E010F0115380131140607310622272E013D012E012731070E0123222627312E012726363F012E013534363707272E01373E01373E013332161731173E013F0135380131343637313632171E011D011E011735373E0133321617311E011716060F011E011514060737273426232206151416333236037A55070602113825030905040602551A3C21030B08346F37080B233D1A5502060405090325381102060755030303040155070602113825030905040602551A3C21030B08346F37080B233D1A55020604050903253811020607550303030401DA5E42425E5E42425E017132040F09356028030401023116230C0163080D020C0C020D08630C24163102010403286035090F04320F24131225110231041008365F28040402013116230C0162090D020C0C020D09620D231" & _
								"7013101020404285F36081004311024121324120346425E5E42425E5E00000000030025FFDC03D703B7001E002900350000013216070E012322272E0127263534373E0137363332161716062B010717330501062227263437011E0101342623220615141633323603C20E0E0726824F3B35344E171716174E35343C4F8226070E0ED25050D2FEA9FE70266A2625250191185FFEA31C14141C1C14141C0227180C3F4D16174D35343B3C34354F17174D3F0C187070BAFE6F2525266A2501913E5FFED2141C1C14141C1C000000060003FFBC04FD03B50053005A00AE00BC01100117000001070E01272E01272E013F012E0127232226272634373E013B013E0137272636373E013736161F01363217373E01171E01171E010F011E0117333216171614070E012B010E0107171606070E010706262F0106222716362726061703171E01070E01070E012F010E0107151406070622272E013D012E0127070626272E012726363F01263437272E01373E01373E011F013E0137353436373632171E011D011E0117373616171E011716060F0116140736272E0127260706171E01171601070E01272E01272E013F012E0127232226272634373E013B013E0137272636373E013736161F01363217373E01171E01171E010F011E0117333216171614070E012B010E0107171606070E010706262F0106222716362726061704001005110812200F060405100A100621090D020303010E092106100A100503070F2012081105101020101005110812200E070405100A100521090E020303020E092105100A100504070E2012081105101020253A5C2C3A5C2CE6430F0C060D30180B230F3A18371F1611254D2611171E38183A0F230B182F0D060C0F430606430F0C060D2F180B230F3A18381E1611254D2611171F37183A0F230B182F0D060B0F4305F12D06064839393A2C050649393902201005110812200F060405100A100621090D020303010E092106100A100503070F2012081105101020101005110812200E070405100A100521090E020303020E092105100A100504070E2012081105101020253A5C2C3A5C2C02391D08060307130C0512081D0C1B0F0C09122612090C0F1C0C1C0812060C12070306081C03031C08060307120C0612081C0C1C0F0C09122513090C0F1B0C1D0812050C13070306081D03782C5C3A2D5D3AFECD2209211024431D0D06092114200B43121B030606031B12430B20142109060D1E4224102109221F401F2209211025421D0D06092114210A44111B030606031B11440A20152208060D1D42251021092120404A3A39394905062C3A3939480606FEBF1D07060306130C0611081D0C1C0F0B09122612090C0F1C0C1D0712060C13060306081C03031C08060306130C0612071D0C1C0F0B09122613090B0F1C0C1D0811060C13" & _
								"060306071D03792D5D392D5C3A00000000030000003704800337002F00400051000025012E012B011716062B0122263F0123220607010E01151416332122263F013E013B0132161F0116062321323635342601373E013B0132161F0116062B01222637132322263F013E013B0132161F01160623046FFEED06180EC004010F0A380B0E0104C00E1806FEED08091C1401AB0A0F0116010E099E090E0116010F0A01AB141C09FD8607010E0948090E0107010F0A560A0F0187880A0F020E010E096A090D010F020F0AB802620E0F260A10100A260F0EFD9E132915141C100AD0090D0C0AD00A101C14152901DC40090D0C0A400A10100AFEF6100A90090D0C0A900A10000000030000FFF70400037700130027002B00000121111406232122263511211514163B013236350115213534363B01353436332132161D0133321625211521028001803828FCC0283801800E0AD00A0E0180FC003828A0382801402838A02838FE80FF0001000177FEE0283838280120280A0E0E0A0108A0A028386028383828603878400000020000FFF703800377000F001F000001212206151114163321323635113426032122263511343633213216151114060320FD402838382802C028383834FD580507070502A805070703773828FD402838382802C02838FCE0070502A805070705FD58050700000000030000FFB7040003B700400080008C0000012326272E012726273534262B0122061D0106070E010706072322061D0114163B0116171E011716171514163B0132363D0136373E013736373332363D01342623013534262B0122061D0126272E012726273332363D0134262B0136373E013736371514163B0132363D0116171E011716172322061D0114163B0106070E01070603140623222635343633321603E83D0A20205F3E3E460E0A500A0E463E3E5F20200A3D0A0E0E0A3D0A20205F3E3E460E0A500A0E463E3E5F20200A3D0A0E0E0AFE580E0A500A0E2C26263D161509510A0E0E0A510915153D27262C0E0A500A0E2C26263D161509510A0E0E0A510915153D27262C251B1B25251B1B2501F7463E3D6020200A3D0A0E0E0A3D0A2020603D3E460E0A500A0E463E3E601F200A3D0A0E0E0A3D0A201F603E3E460E0A500A0EFE97510A0E0E0A510915153D27262C0E0A500A0E2B27263D161509510A0E0E0A510915163D26262C0E0A500A0E2C26273D151501201B25251B1A2626000002001CFFB702E4038B001E002D00000522272E0127263534373E0137363736161716171E0117161514070E010706032622070E0115141633323635342601804A4141601C1C21215E3332240E5C0C2433335D21211C1C6041419F0212020E2A271C1C272A491C1C6041414A53403F855151772D022B77515184403F544A4141601C1C015808082D291F1C27271C1F2" & _
								"90003000000370480033700030021003100000121112125141633151406232122263D01323635342623353436332132161D0122062734262321220615111416332132363501000280FD80032038283828FC40283828383828382803C028382838601C14FD60141C1C1402A0141C0277FE80C02838C028383828C038282838C028383828C038A8141C1C14FE60141C1C1400030010FFC703F003A7001B0037004D00000122070E0107061514171E0117163332373E0137363534272E0127260322272E0127263534373E0137363332171E0117161514070E01070637272E01351134363B0132161511171E010F010E01270200675A5A8727272727875A5A67675A5A8727272727875A5A675349496C201F1F206C4949535349496C201F1F206C494929AA05050E0A400A0E860803062606130803A72727875A5A67675A5B8627272727865B5A67675A5A872727FC801F206C4949535349486D1F20201F6D4849535349496C201FD17B040A0501490A0E0E0AFEE461061308340803060000050000FFF704000377000D0011001B00250049000017211123353426232122061D012337211521051114062B011133321601232226351134363B01011514062B011514062B0122263D012322263D0134363B013534363B0132161D01333216C00280403828FEC0283840C00100FF000280382820202838FC802028383828200240130D60130D400D13600D13130D60130D400D13600D130902C0602838382860404060FE00283802C038FD78382802002838FEE0400D13600D13130D60130D400D13600D13130D6013000000040000FFF704000377002C00360040004A000001233E01353426232206072E01232206151416172322061D0114163B01151416332132363D013332363D013426253E01333216151406232532161723222635343613331114062B0122263503D081171A714F3F58292C593B4F711A1781141C1C1410382802C0283810141C1CFE4C2453191A26261AFE80195324901A26267AC01C1460141C02371942254F713A323537714F2542191C14A0141CE028383828E01C14A0141C40542C261A1B25802C54251B1A26FF00FE90141C1C140000030010FFC703F003A7001B0027004600000122070E0107061514171E0117163332373E0137363534272E0127260732161514062322263534361314062B0122263D0134363B01352322263D0134363B0132161D01333216150200675A5A8727272727875A5A67675A5A8727272727875A5A6723313123233131930E0AB00A0E0E0A18180A0E0E0A800A0E180A0E03A72727875A5A67675A5B8627272727865B5A67675A5A872727DC3123233131232331FE040A0E0E0A300A0E800E0A300A0E0E0AC80E0A00000000020000FFB7018003B7001F002B00003733112322263D0134363B01321615" & _
								"113332161D011406232122263D0134363313220615141633323635342628282811171711E011172811171711FED011171711983C54543C3C545466012118106010181810FE5717115F111717115F11170351543C3C54543C3C5400000000020006FFF7047B0376002300460000011114062B0122263D0134262B0122061D0114062B012226351134363701363217011E0137271134262B0122061D0127262207010E011F011E0137013632170116363F0136262703D01C14E80A0E0E0A900A0E0E0AE8141C0504017806120601780405A7A70E0A700A0EB31B441BFE060802073306140701D706120601D7071407330602080145FEE2141C0E0AE00A0E0E0AE00A0E1C14011E060A0301360505FECA030A748A01150A0E0E0A91931616FE5F0614083E07020601840505FE7C0602073E08140600000002003CFFBE0444039300190024000001250326220703050E011F01030616372505163627033736262701132707132725371705070420FEDC8311501183FEDC27191CD4320741230105010523410732D41C1828FEE930F9F930C901167C7C0116C902602A01092424FEF72A064C1BCEFEDD282E128A8A122E280123CE1B4C06FEE6FEEB83830115C429FCFC29C4000000010000FFB7048003B7002F00000122070E0107061D012122061511141633213236351134262B013534363732161D0114163B0132363D0134272E012726034F3F3737531718FE402838382802C02838382860533C3C551C1440141C181853373803B719185437383F8D3828FE8028383828018028388E3B5601543CA0141C1C14A03F373852181800030000004704800327002A0046006D00000126272E0127262322070E010706070E01151416172316171E0117163332373E013736373E0135342627330122272E0127263534373E0137363332171E0117161514070E0107061314070E0107062322272E0127263534363731141633323635342623313E013332171E0117161504732B3B3C9153535A5A5354903C3B2B06070707012B3B3C9153535A5A5354903C3B2B0607070701FDCD3832314A161515164A3132383832314A161515164A31329810113826262B2B26263811100D0B33232432322416311B2B262638111001E8473B3B5417171717543B3B470B190D0E190A483A3B5417171717543B3A480B180E0D190BFEBF1516493231393832314A151616154A31323839313249161501102B262638111010113826262B1A32162432322423320C0D10113826262B000000020000FFD303E403B70015002100001311343633213216170116140701062227012E013531132206151416333236353426003828019814230D01A81C1CFE681C501CFE580D0FE02838382828383801BF019828380F0DFE581C501CFE681C1C01A80D2314017838282838382828380000010" & _
								"010FFB7040003B7003A00000122272E012726232206073E01353C0135312E01272606151416171114163B0132363D013E013332171E011716333236373E0135113426070E012302BB2826254F2B2B3226431F0304033E2A30451A161C1420141C2A6F4C2826254F2B2B324977350D0F3B20337A3D02F10B0B1A0B0B0D0B09140B0203022B3C0202432F1D300FFCFC141C1C14BD121A0B0B1A0B0B2D25091C1001E623260F182800000000020000FFB7040003B7003A004E00000122272E012726232206073E01353C0127312E01272606151416171114163B0132363D013E013332171E011716333236373E0135113426070E0123010E0123222623220607113E013332163332363702A02523244E2B2B332F51220203010432232A3C1A16130D200D133972552523244E2B2B3358822814175630366E360100216D3F59905A41902F216D3F59905A41902F03170A0A180A0A110D0610080306022230030239291B2C0CFCD30D13130DA71A1F0A0A180A0A361A0D2B1801E03439151721FE001729401A1601D01729402A16000000010027FFC003D903C0005A0000012E012F01373E013736262F012E012726060F01353426272E012B012206070E011D01272E01070E010F010E01171E011F01070E010706161F011E011716363F01151416171E013B013236373E013D01171E01373E013F013E012703D9041410B1B11014040505082B091912112010B10D0C0D1E1156111E0D0C0DB11020111219092B080505041410B1B11014040505082B091912112010B10D0C0D1E1156111E0D0C0DB11020111219092B0805050126111A086767081A1112200F4A0F140405040966CD111E0D0C0D0D0C0D1E11CD6609040504140F4A0F2012111A086767081A1112200F4A0F140405040966CD111E0D0C0D0D0C0D1E11CD6609040504140F4A0F20120000030000FFB7040003B7000F001B004D000013232206151114163B013236351134260322263534363332161514060114060733321615140607311606071606071606070E012B012226272E0127222635113436373E01373E01373E0133321615D0A0141C1C14A0141C1C64141C1C14141C1C026C380BCC324515120F071B0D151806060D1E85400648782F183A170A0E04033C4630171408071F1E246C01F71C14FE20141C1C1401E0141CFE101C14141C1C14141C030D40532A472D1B36122359232755191B2D122C0F2A150B15010E0A01AB0509033B7730173F201C58356E00010000FFF704800377002700000114070E010706232226270E01070626272636373E01372E013534373E0137363332171E0117161504802D2E9C69697748883C3C924F070E02020A061D3D0D373E2D2E9C6969777769699C2E2D01D7564C4C71202119162E3908010907080B051C455C358047564C4C7021212121704C" & _
								"4C5600020000FFF704800377002B00530000252226270E0107302223312226272636373E01372E013534373E0137363332171E0117161514070E01070623052E0127363736262726271C011514070E0107062716171E011716333236371E011716363736262701C0386A2E2F713E010105090201070516300A2B3023237A52515D5D51527A232323237A52515D02B6152C0A341414152728432D2E9B6768741D23234F2C2C2F34622B2C6939060902010704E91412252D060705060805153649296538443B3C581A1A1A1A583C3B44443B3C59191AD6133242303939703333260204025C4F4F721F1F041812131A0707111122280601070505080400000000020000FFF704800377002A004B00000122070E010706151416170E01070E01171E013736373E013736371E013332373E0137363534272E012726032226270E01073E01372E013534373E0137363332171E0117161514070E01070602407769699C2E2D433C0D2717102C0B082B192C292A4F2525222B5C307769699C2E2D2D2E9C696977316230308954304406395120207A595A73735A597A202020207A595A03772121704C4C564A85362224100B2823171A02040707150F0E110A0B2120714C4C56564C4C702121FD200D0F1D430C2464292772463539385E1E1E1E1E5E3839353539395D1E1E00000000030000FFF704800377002E004F007E0000250E0123222627060706262726273E01373E01371E01332E01273E01353426273E01271E01151406071E01171E01070122070E010706151416170E01073236371E013332373E0137363534272E0127262732171E011716151406070E01070E01070E01232226270E01232226272636373E01372E01272E013534373E013736047D083421306735262928512828243E7536183118206638302804263607070B040531332521040A061D1A08FD635C4847621A19412E062F3A437B26274E275C4847621A19191A6247485C7159597B21211313113220204B2B2C61342547233F7939213507081C1D0C11060B1309181821207C59593F20281E1D080303060A0910051C19010A08152E1A3E1D1C53331021102749242E6F38335C27030703103C2002D819184D2E2E2C395E2020461D34170C0B19184D2E2E2C2C2E2E4D1819602020673F404022462120391819280D0F0F080822222920213C0F060C050C190D244F29403F40672020000000030002FFB7037E03B7003E004500610000012E013534272E012726273E0135380139013426232206153801311416173506070E010706151406070607061617163B011416333236353332373E012726270122263533140625212226373E013534373E0137363332171E0117161514161716062303531A2B16154C33343B0506251B1B2506053B34334C15162B1A2407061D21212BBA4B35354" & _
								"BBA2B21211D060724FE6D141C601C0126FD8C1914122B3C1313402C2B31312B2C4013133C2B121419012119547B3E3838581D1D0A07130A1A26261A0A1308010A1D1E5738383E7B5419242929461717354B4B35171746292924FEE61C14141C902F112B7592312C2B4013131313402B2C3192752B122E0002001CFFB7036403B7003200400000252E013534272E012726273E01353801390134262322061514161706070E0107061514060706163B01141633323635333236270532161514062331222635331416036422421415483130390506251B1B25060539303148151442222D3140E04B35354BE040312DFE5C07090907212F201CDB2179A23B3635541C1C0A07130A1A26261A0A13070A1C1C5435363BA279212D77354B4B35762ED40A0607092F21141C00000000020020FFB7016003B7000B001C000025140623222635343633321601131E013B013236371336262B0122061701605E42425E5E42425EFED31B011B1484141B011B021D14BC141D0257425E5E42425E5E02EBFDE0131A1A130220151E1E15000003000DFFB704730387000C0018002900002516062321222637013632170125220615141633323635342603131E013B013236371336262B0122061704731C3837FC4037381C01E01C6F1B01E0FDCD263636262636367D0E010E0962090E010E010E0B7E0B0E01473060603003403030FCC0AC3626263636262636014BFEF00A0D0D0A01100A0F0F0A00000000030010FFC703F003A7001B0027003800000114070E0107062322272E0127263534373E0137363332171E01171605220615141633323635342603131E013B013236371336262B0122061703F02727875A5A67675A5A8727272727875A5A67675A5A872727FE10263636262636367D0E010E0962090E010E010E0B7E0B0E0101B7675A5B8627272727865B5A67675A5A8727272727875A5ACB3626263636262636014BFEF00A0D0D0A01100A0F0F0A0000020000FFCC030003B7001E002A00000526272E0127263534373E0137363332171E0117161514070E01070607062213323635342623220615141601596D44434B0D0D1E1E69464550504546691E1E0D0D4B43446D0E3219425E5E42425E5E349D5F5F7C2D2D3A4F4646691E1E1E1E6946464F3A2D2D7C5F5F9D1501E05E42425E5E42425E00000000040010FFC703F003A7001B0037004A005600000122070E0107061514171E0117163332373E0137363534272E0127260322272E0127263534373E0137363332171E0117161514070E01070613030E01073107062637133E013731373616070722061514163332363534260200675A5A8727272727875A5A67675A5A8727272727875A5A675349496C201F1F206C4949535349496C201F1F206C49496443020705CD1A3E0843020705CD1A3E08B71B2525" & _
								"1B1B252503A72727875A5A67675A5B8627272727865B5A67675A5A872727FC801F206C4949535349486D1F20201F6D4849535349496C201F0270FEED070C05C31923240113070C05C3192423A0261A1B25251B1A26000000020000FFB7030003B70011001C0000011121220615111416332132363511212226251521113332161F011E0101C0FE70141C1C1402A0141CFEF0141C0140FF000C0A1107C4070702A701101C14FC60141C1C1402901C300C01000707C4071100050000FFB7030003B7000F001F00330036003F000001151406232122263D01343633213216072122061D011416332132363D013426131114062321222635113436332132161F011E0125153313112322263D01211102400E0AFEB00A0E0E0A01500A0E18FEB00A0E0E0A01500A0E0ECE3828FDC028383828019813230EA80D0FFF009808D0141CFEC001C7380A0E0E0A380A0E0E9A0E0A380A0E0E0A380A0E0178FD6828383828034028380F0DA80D248D98FD6002401C14D0FCC000030000FFB7050003B70003001300310000011121112521220615111416332132363511342613212206070E012B012226272E01232122061D011416332132363D0134260400FD000320FCC0283838280340283838A0FE2304070103241880182403010704FE230A0E3828044028380E0337FE000200803828FDC02838382802402838FCC00604171F1F1704060E0A4828383828480A0E0000050000FFF704000377000F00130017001B001F0000012122061511141633213236351134260121352135213521012135213521352103A0FCC0283838280340283838FDF8FEC00140FEC0014001C0FEC00140FEC0014003773828FD402838382802C02838FD00C080C0FE00C080C00000020000FFF704800377003500500000250E012322272E0127263122062322263534363530263534373E0137363736373E013736373E013332171E0117161514070E010706072536373E0137361716363736262726070E010706070616171636370317418F4A3D3737531818183D2A28287F191C1D5F3E3F44324848924040221A28291B121316050515155844455EFE033036377F494A550D140101110D5D52518E3D3D3508050B0A1B076D20250D0D1E0C0D823716324D1B3E394C404167262616110202050A0A1F19261E1E50282815534D4D883B3A2F974430313B0C0B0701120D0D1401070C0D4335364B0B1A0708050A0000030019FFF705000377001A0023002B000025213236353332373E0137363534272E01272623212206151114160132161514062B01111321222633213206018001804F7140352F2E4614141414462E2F35FCF0141C7002D0354B4B35409FFC02482626048E2626B770501414462E2F35352E2F4614141C14FE30507002404B35354B0100FD00808000020005FFBC04000" & _
								"3B7003600420000012E01272E012322070E010706072322060F0106163B010E010706161F011E01373E01371514163F013E013D0136373E0137363534262703222635343633321615140603F2020D093050254E3E3F662A2923D01B2F0C630C1C1BBE08120A0403078007140A1226132E17C6181D362F2F451314030BD2283838282838380391090D020A041413452F2F361D18C6182D1326130914087F070304091209BE1B1C0C630C2E1BD123292A663F3E4D264F31FEE6382828383828283800000000020010FFC703F003A7001B002A00001314171E0117163332373E0137363534272E0127262322070E010706011132171E0117161514070E010706102727875A5A67675A5A8727272727875A5A67675A5A87272701F04C4343641D1D1D1D64434301B7675A5B8627272727865B5A67675A5A8727272727875A5AFE2902E01D1D6443434C4C4343641D1D000000020000FFB7038003B700200029000001233534272E0127262322070E0107061D0123220615111416332132363511342623213534363332161503203018185238373F3F3738521818302838382802C0283838F8FEE0543C3C5401F7903F373753181818185337373F903828FE802838382801802838903B55553B0000030000FFB703C003B70031005C00680000013E013534262B013E013534262322070E010706070E0107232206151114163B013236371E01333A01333236373E01273E010716060716062B0122272E01272623113332373E013736373E0137321615140615333216151406231E010705140623222635343633321603A50D0E634949080A68562F18181A06070A224B1CC61B25251B8016230543869B0A180A746C021413040E0B831318170C41354C352E2D5226272816151919321818142A051D461839D0202C1E0F150120FD871C14141C1C14141C017917301D4269142E1B6E641E1E4D23230A226C19261AFE201B251B15024E6B541B47231C414A20470C493B0C0C1C0C0C017417173F2121142A761D4E243A4A392F1C1D2F164F1EB7141C1C14141C1C000000030010FFC703F003A7001B0049005500000114070E0107062322272E0127263534373E0137363332171E0117162522060706161F011636373E01333216151406070E011D0114163B0132363D0134373E0137363534272E0127262303220615141633323635342603F02727875A5A67675A5A8727272727875A5A67675A5A872727FE1D516F29050308450813061B2F291F3C221F234A0E0A700A0E1A1A3E1A1A1415422A292B0D2636362626363601B7675A5B8627272727865B5A67675A5A8727272727875A5AE5423E081206350603072226241E161D11143C3D080A0E0E0A03150E0F2821203A2B2625370F10FE10362626363626263600000000010020FFF304600387002E00000122" & _
								"070E0107060726272E0127262322070E0107061514171E01171617011632370136373E0137363534272E012726033E282626421B1B12121B1B422626284436364A141415153316160101760E240E017502161633151514144A363603870E0E28161712121716280E0E13144934354237303149161602FE960C0C01690216174931303742353449141300000000020030FFE704500387002B00470000250126272E0127263534373E013736333216173E013332171E0117161514070E0107060F01010E012322262709023E013534262322070E0107060726272E0127262322061514160203FEB605161631141315144F3839473E732F2F733E4538385015160B0B2618191B01FEB60B201212200BFEF90144014429436D632322223C17180E0D17173C222324636D430001440517174B3030374438384F15163B29293B15144E3838472726264820201A01FEBD0C0D0D0C0189FEC1013E287039656910102C17180E0D17172D1011696538720001003CFFBE04440393001900000103050E011F0103061637250516362703373626272503262207020783FEDC27191CD4320741230105010523410732D41C1828FEDC831150110393FEF72A064C1BCEFEDD282E128A8A122E280123CE1B4C062A010924240000000001003CFFBE024003B7000E00000122060703050E011F010306163725024011200883FEDC27191CD432074024010503B71212FEF72A064B1CCEFEDD272F128A0001003CFFBE024003B7001500002507132725373522060703050E011F010306163725350240F930C901167C11200883FEDC27191CD4320740240105B4830115C429FC881212FEF72A064B1CCEFEDD272F128A6C00020000FFB7040003B7001B003400000132171E0117161514070E0107062322272E0127263534373E013736012706070626272627070E011D011416332132363D013426270200423B3A5719191919573A3B42423B3A5719191919573A3B01B18F383D3D7636362C8F4051382803402838514003B71919573B3A42423B3A5719191919573A3B42423A3B571919FD642429101104131320241068424A283838284A42681000060000003705000337001B0033003F004B005F007300000132171E0117161514070E0107062322272E0127263534373E013736012706070626272627070E011D011416332132363D0134261732363534262322061514162132363534262322061514161735343637062627070E011D0114163B013C013525270E01271E011D011C01153332363D0134262702802B272639101111103926272B2B27263910111110392627010E502528274E24231D50303D2A1E02101E2A3D8D3A52523A3A5252FCFA3A52523A3A52526A0D0C2D5C223520291C14E003A7352A5C260D0DE0141C2920033711103926272B2C262639111010113" & _
								"926262C2B2726391011FE4D141A0B0B020D0D14140C4E32791E2A2A1E79324E19523A3A52523A3A52523A3A52523A3A52E079192F14160C180D08342151141C020402D60D1E0212142F19790204021C145121340800020000FFB7018003B7000B002900001332161514062322263534361323062227232206151114163B011114163B013236351133323635113426C0354B4B35354B4B9517224D231728381C14201C1480141C20141C3803B74B35354B4B35354BFEE010103828FEF0141CFEF0141C1C1401101C140110283800020011FFB701EF03B7000B002B000001321615140623222635343601032E012B010622272322060F010306163B011514163B0132363D01333236270100354B4B35354B4B012460041A1117224D2317111A030160051D17701C1440141C70171D0503B74B35354B4B35354BFD3B018010151010150F01FE801625D0141C1C14D025160000060000FFF704000377000F001F00340050005C006E000013220615111416332132363511342623053332161D0114062B0122263D013436052122263D0134363321373E01332132161D0114060122272E0127263534373E0137363332171E0117161514070E0107060322061514163332363534260722263534363332161514062322061514066028383828034028383828FCC0D405070705E80507130361FC980507070501143C02050301FA0D1307FE47322B2C4113131313412C2B32322B2C4113131313412C2B3249676749496767A90D134B350D13130D1A261303773828FD402838382802C028384007052805070705140D13C007054805075A0303130D940507FDF01313412C2B32322B2C4113131313412C2B32322B2C41131301A06749496767494967D0130D354B130D0D13261A0D130000000001000F004803F1032600150000250126343F0136321F010136321F0116140701062227015CFEB30F0F480F2B0FE001E00F2B0F480F0FFDB30F2A0F48014D0F2A0F490F0FE101E10F0F490F2A0FFDB30F0F000000020010FFC703F003A7001B003100000114070E0107062322272E0127263534373E0137363332171E011716090136342F01262207012726220F0106141F0116323703F02727875A5A67675A5A8727272727875A5A67675A5A872727FDD7017009092E091B09FED48C091B092E0909D00A1A0A01B7675A5B8627272727865B5A67675A5A8727272727875A5AFE9201700A1A092E0909FED48C09092E091A0AD00909000000030010FFC703F003A7001B0037004D00000122070E0107061514171E0117163332373E0137363534272E0127260732171E0117161514070E0107062322272E0127263534373E0137360127262207012726220F0106141F01163237013634270200675A5A8727272727875A5A67675A5A8727272727875A5A675349496C20" & _
								"1F1F206C4949535349496C201F1F206C4949016B2D071407FEE6780714072D0707B50714070159070703A72727875A5A67675A5B8627272727865B5A67675A5A87272760201F6D4849535349496C201F1F206C4949535349486D1F20FEFB2E0707FEE77907072D071407B70707015607140700000000020000FFF703800377000F0025000005212226351134363321321615111406250136342F01262207012726220F0106141F011632370320FD402838382802C0283838FE3F017009092E091B09FED48C091B092E0909D00A1A0A09382802C028383828FD402838C40170091B092D0A0AFED48C0A0A2D091B09D009090001000E004502F2032900230000253736342F013736342F0126220F012726220F0106141F010706141F0116323F0117163202866C0E0EC2C20E0E6C0E270FC2C20E280E6C0E0EC2C20E0E6C0E280EC2C20E28456C0E270EC3C20E280E6C0E0EC3C30E0E6C0E280EC2C30E270E6C0E0EC2C20E0000020010FFC703F003A7001B003F00000122070E0107061514171E0117163332373E0137363534272E0127261316140F0106222F010706222F0126343F012726343F0136321F013736321F0116140F010200675A5A8727272727875A5A67675A5A8727272727875A5A8C07074F07140782820714074F0707838307074F07140782820714074F07078303A72727875A5A67675A5B8627272727865B5A67675A5A872727FD8E0714074F0707838307074F07140782820714074F0707838307074F0714078200030010FFC703F003A7001B0037005C00000122070E0107061514171E0117163332373E0137363534272E0127260322272E0127263534373E0137363332171E0117161514070E01070613071716140F0106222F010706222F0126343F012726343F0136321F013736321F011614070200675A5A8727272727875A5A67675A5A8727272727875A5A675349496C201F1F206C4949535349496C201F1F206C4949797D7D07072E0714077C7C0714072E07077D7D07072E0714077C7C0714072E070703A72727875A5A67675A5B8627272727865B5A67675A5A872727FC801F206C4949535349486D1F20201F6D4849535349496C201F020C7C7D0713082D07077D7D07072D0813077D7C0714072D08087C7C08082D0714070000050010FFC703F003A7001B00370052006C007400000132171E0117161514070E0107062322272E0127263534373E0137363722070E0107061514171E0117163332373E0137363534272E0127261322060731321615140623222635310E01151416333236353426232122060731321615140623222635310E01151416333236353426132122143321323402005349496C201F1F206C4949535349496C201F1F206C494953675A5A8727272727875A5A67675A5A8727272727875A5A190E1" & _
								"B0C131B1B13131B0607422E2E42422EFF000E1B0C131B1B13131B0607422E2E4242E2FEE030300120300347201F6D4849535349496C201F1F206C4949535349486D1F20602727875A5A67675A5B8627272727865B5A67675A5A872727FEF007061B13141B1B140C1B0E2F41412F2E4207061B13141B1B140C1B0E2F41412F2E42FE9060600000020020FFB703E003B7002C003700000114070E010706070E01232226273326272E0127263538013134363733253E013332161723051E011538013901013136373E01373637251103E02D2D864E4D4008130A0A130901504F507E2727211901018008130A0A13090101801A21FE20463F3F5F1D1D03FEA002B7A68281BD3C3C1B03040403224343C27D7D951E2F0BA004040404A00B2F1EFD83233A3A9D61617292FD0600010000013A03800233000F00000132363D013426232122061D011416330350141C1C14FCE0141C1C14013A1D1399141C1C1499131D000000020010FFC703F003A7001B002B00000122070E0107061514171E0117163332373E0137363534272E0127260122263D013436332132161D011406230200675A5A8727272727875A5A67675A5A8727272727875A5AFE910A0E0E0A02100A0E0E0A03A72727875A5A67675A5B8627272727865B5A67675A5A872727FDC00E0A700A0E0E0A700A0E0000050010FFC703F003A7001B00370052006C008000000132171E0117161514070E0107062322272E0127263534373E0137363722070E0107061514171E0117163332373E0137363534272E0127261322060731321615140623222635310E01151416333236353426232122060731321615140623222635310E01151416333236353426013626070607062227262726061716171632373602005349496C201F1F206C4949535349496C201F1F206C494953675A5A8727272727875A5A67675A5A8727272727875A5A190E1B0C131B1B13131B0607422E2E42422EFF000E1B0C131B1B13131B0607422E2E424201591C4D1D253130663031251D4D1C3445459146450347201F6D4849535349496C201F1F206C4949535349486D1F20602727875A5A67675A5B8627272727865B5A67675A5A872727FEF007061B13141B1B140C1B0E2F41412F2E4207061B13141B1B140C1B0E2F41412F2E42FE9327392733191A1A193327392746242323240000050010FFC703F003A7001B00370052006C008100000132171E0117161514070E0107062322272E0127263534373E0137363722070E0107061514171E0117163332373E0137363534272E0127261322060731321615140623222635310E01151416333236353426232122060731321615140623222635310E0115141633323635342601262726220706070616373637363217161716362702005349496C201F1F206C4949535349496C" & _
								"201F1F206C494953675A5A8727272727875A5A67675A5A8727272727875A5A190E1B0C131B1B13131B0607422E2E42422EFF000E1B0C131B1B13131B0607422E2E424201292A39387739392A1C4D1C1C25244B24241C1C4E1D0347201F6D4849535349496C201F1F206C4949535349486D1F20602727875A5A67675A5B8627272727865B5A67675A5A872727FEF007061B13141B1B140C1B0E2F41412F2E4207061B13141B1B140C1B0E2F41412F2E42FE6C3A1D1D1D1D3A263926271313131327253727000000030000FFB7038003B7000F001B002B000001212206151114163321323635113426012226353436333216151406251406232122263511343633213216150320FD402838382802C0283838FE781B25251B1B252501450E0AFD700A0E0E0A02900A0E03B73828FCC02838382803402838FC40251B1A26261A1B25D80A0E0E0A02700A0E0E0A00000000030000FFF704000377000F00130017000001212206151114163321323635113426012111210121112103A0FCC0283838280340283838FDF8FEC0014001C0FEC0014003773828FD402838382802C02838FD000200FE00020000000000030000FFB7028003B7000F001B002B000001212206151114163321323635113426012226353436333216151406371406232122263511343633213216150220FE402838382801C0283838FEF81B25251B1B2525C50E0AFE700A0E0E0A01900A0E03B73828FCC02838382803402838FC40251B1A26261A1B25D80A0E0E0A02700A0E0E0A00010010FFC703F003A7001B00000122070E0107061514171E0117163332373E0137363534272E0127260200675A5A8727272727875A5A67675A5A8727272727875A5A03A72727875A5A67675A5B8627272727865B5A67675A5A8727270000000001000000010000958A9FB75F0F3CF5000B040000000000D6D6235300000000D6D623530000FFB7050003C00000000800020000000000000001000003C0FFC0000005000000000005000001000000000000000000000000000000620400000000000000000000000200000003800000038000000300002004800000050000000340000004000000036E0000036E000004000000048000000400001004800000038000000300003C03800000040000010380000004000000040000000480000004800000040000260400002505000003048000000400000003800000040000000300001C048000000400001004000000040000000400001001800000048000060480003C0480000004800000040000000400001004000000040000270400000004800000048000000480000004800000038000020380001C018000200480000D040000100300000004000010030000000300000005000000040000000480000005000019040000050400001003800000040" & _
								"000000400001004800020048000300480003C0480003C0480003C04000000050000000180000002000011040000000400000F0400001004000010038000000300000E04000010040000100400001004000020038000000400001004000010040000100380000004000000028000000400001000000000000A0014001E006000C4014401E2025202C803040398040C04A004DA053205AC05F0064C070A075207BA07DA08160850089C095209A80B4A0BC40C060C3A0CFA0D420D8A0E000E660ECE0F320F700FDC10241068110811401196120812921302134213C0143614F4157C15D61606164C16A416E8176C179C17FA1846187E18F8193C19A219E81A261ABA1B381B861BF61C2A1C4A1C741CC61D6A1DA61DE81E841EAE1F001F7A1FB81FF2205420E0218221D421F0223422EA23A223E6241424562486000000010000006201180008000000000002000000000000000000000000000000000000000E00AE0001000000000001000C000000010000000000020007008D0001000000000003000C00450001000000000004000C00A20001000000000005000B00240001000000000006000C0069000100000000000A001A00C600030001040900010018000C0003000104090002000E00940003000104090003001800510003000104090004001800AE00030001040900050016002F000300010409000600180075000300010409000A003400E0526F636B2D436865636B696E0052006F0063006B002D0043006800650063006B0069006E56657273696F6E20312E3000560065007200730069006F006E00200031002E0030526F636B2D436865636B696E0052006F0063006B002D0043006800650063006B0069006E526F636B2D436865636B696E0052006F0063006B002D0043006800650063006B0069006E526567756C61720052006500670075006C00610072526F636B2D436865636B696E0052006F0063006B002D0043006800650063006B0069006E466F6E742067656E6572617465642062792049636F4D6F6F6E2E0046006F006E0074002000670065006E006500720061007400650064002000620079002000490063006F004D006F006F006E002E00000003000000000000000000000000000000000000000000000000000000000000"
#EndRegion; IconFont

Global $aLabels[0][4]		;Element 0: Handle of ListViewItem
							;Element 1: Label Name
							;Element 2: Label ZPL
							;Element 3: JSON of merge field configurations
Global $iSelectedLabel = -1


#Region; GUI
$hGUI = GUICreate("Print Blank Labels v3.0", 865, 780)

GUICtrlCreateLabel("", 0, 0, 865, 65)
GUICtrlSetBkColor(-1, $darkBackgroundColor)
GUICtrlSetState(-1, $GUI_DISABLE)

GUICtrlCreateLabel("Add Labels to print", 232, 10, 400, 20, $SS_CENTER)
GUICtrlSetBkColor(-1, $GUI_BKCOLOR_TRANSPARENT )
$hBtn_LoadLocal = GUICtrlCreateButton("Open from File", 242, 25, 122, 25)
$hBtn_LoadRemote = GUICtrlCreateButton("Load from Server", 372, 25, 122, 25)
$hBtn_LoadBlank = GUICtrlCreateButton("Add Blank Label", 502, 25, 122, 25)

; ------------------------ End Header

$hListview_Labels = GUICtrlCreateListView("Labels to print", 20, 85, 395, 255)
_GUICtrlListView_SetColumnWidth($hListview_Labels, 0, $LVSCW_AUTOSIZE_USEHEADER)
$hBtn_RemoveLabel = GUICtrlCreateButton("Delete selected label from list", 20, 340, 160, 25)

$hBtn_UpdateCode = GUICtrlCreateButton("Update Code", 295, 355, 120, 25)
$hInput_LabelCode = GUICtrlCreateEdit("", 20, 380, 395, 283, BitOR($ES_WANTRETURN, $WS_VSCROLL, $ES_AUTOVSCROLL))

; ------------------------ Column Break

GUICtrlCreateGroup("Security Code Format", 439, 85, 406, 75)

$hRadio_SequentialCode = GUICtrlCreateRadio("Sequential numbers starting at:", 449, 100, 165, 20)
$hInput_CodeStart = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "SequentialCodeStart", "1"), 616, 100, 60, 20)
GUICtrlonchangeRegister($hInput_CodeStart, "UpdateSequentialCodeStart")
GUICtrlCreateUpDown( $hInput_CodeStart )
$hRadio_RandomCode = GUICtrlCreateRadio("Random alphanum codes", 449, 130, 150, 20)

$sDefaultCodeType = IniRead($sFilePath_Settings, "Settings", "CodeType", "Random")
If $sDefaultCodeType == "Random" Then
	GUICtrlSetState($hInput_CodeStart, $GUI_DISABLE)
	GUICtrlSetState($hRadio_RandomCode, $GUI_CHECKED)
ElseIf $sDefaultCodeType == "Sequential" Then
	GUICtrlSetState($hRadio_SequentialCode, $GUI_CHECKED)
EndIf

GUICtrlCreateLabel("Prefix:", 740, 103, 35, 20)
$hInput_CodePrefix = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "CodePrefix", "M"), 775, 100, 60, 20)
GUICtrlSetLimit($hInput_CodePrefix, 3)
GUICtrlonchangeRegister($hInput_CodePrefix, "UpdateCodePrefix")
GUICtrlCreateLabel("Code Length (after prefix):", 645, 133, 130, 20)
$hInput_CodeLength = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "CodeLength", "2"), 775, 130, 60, 20)
GUICtrlSetLimit($hInput_CodeLength, 1)
GUICtrlCreateUpDown( $hInput_CodeLength )
GUICtrlSetLimit(-1, 6, 1)
GUICtrlonchangeRegister($hInput_CodeLength, "UpdateCodeLength")


; Note that the merge field configuration window is created in LabelClicked()
; But create a frame for it to fill out...
GUICtrlCreatePic("", 439, 180, 406, 245, $WS_BORDER)

GUICtrlCreateLabel("Label Preview:", 439, 440, 80, 20)
Global $hCheckbox_ShowAllFields = GUICtrlCreateCheckbox("Preview all fields", 520, 437, 110, 20)
GUICtrlSetState($hCheckbox_ShowAllFields, IniRead($sFilePath_Settings, "Settings", "PreviewAllFields", $GUI_UNCHECKED))
Global $hBtn_ReloadPreview = GUICtrlCreateButton("Reload Preview", 725, 440, 120, 20)
Global $hPreview = GUICtrlCreatePic("", 439, 460, $iPreviewImgWidth, $iPreviewImgHeight, $WS_BORDER)

; ------------------------ Start Footer

GUICtrlCreateLabel("", 0, 685, 865, 95)
GUICtrlSetBkColor(-1, $darkBackgroundColor)
GUICtrlSetState(-1, $GUI_DISABLE)

GUICtrlCreateGroup("", -99, -99)

$hRadio_IPPrinter = GUICtrlCreateRadio("Network Printer (IP Address)", 20, 700, 160, 20)
GUICtrlSetBkColor(-1, $darkBackgroundColor )
GUICtrlCreateLabel("Printer Address", 20, 725, 160, 15)
GUICtrlSetBkColor(-1, $GUI_BKCOLOR_TRANSPARENT )
$hInput_PrinterIP = GUICtrlCreateInput("192.168.0.20", 20, 740, 160, 20)
GUICtrlonchangeRegister($hInput_PrinterIP, "UpdatePrinterIP")

$hRadio_SharePrinter = GUICtrlCreateRadio("Shared Printer", 200, 700, 160, 20)
GUICtrlSetBkColor(-1, $darkBackgroundColor )
GUICtrlCreateLabel("Printer Address", 200, 725, 160, 15)
GUICtrlSetBkColor(-1, $GUI_BKCOLOR_TRANSPARENT )
$hInput_PrinterUNC = GUICtrlCreateInput("\\localhost\zpl", 200, 740, 160, 20)
GUICtrlonchangeRegister($hInput_PrinterIP, "UpdatePrinterUNC")

$sPrinterMode = IniRead($sFilePath_Settings, "Settings", "PrinterType", "IP")
If $sPrinterMode == "IP" Then
	GUICtrlSetState($hInput_PrinterUNC, $GUI_DISABLE)
	GUICtrlSetState($hRadio_IPPrinter, $GUI_CHECKED)
ElseIf $sPrinterMode == "UNC" Then
	GUICtrlSetState($hInput_PrinterIP, $GUI_DISABLE)
	GUICtrlSetState($hRadio_SharePrinter, $GUI_CHECKED)
EndIf

GUICtrlCreateGroup("", -99, -99)

GUICtrlCreateLabel("Sets of labels to print:", 500, 725, 120, 20)
GUICtrlSetBkColor(-1, $darkBackgroundColor)
$hInput_PrintCopies = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "PrintCopies", "10"), 500, 740, 60, 20)
GUICtrlonchangeRegister($hInput_PrintCopies, "UpdatePrintCopies")
GUICtrlCreateUpdown($hInput_PrintCopies)
GUICtrlSetLimit(-1, 100, 1)

$hBtn_Print = GUICtrlCreateButton("Print", 740, 720, 105, 40)

GUISetState()

#EndRegion; GUI

RestoreAutoSaveLabels()

While 1
	$msg = GUIGetMsg()
	Switch $msg
		Case $GUI_EVENT_CLOSE
			ExitNow()
		Case $hBtn_LoadRemote

			Local $hGui_RemoteLabels = GUICreate("Load Remote Labels", 480, 270)
			GUICtrlCreateLabel("Server", 10, 10, 120, 20)
			Local $hInput_RemoteServer = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "RemoteServer", "rockrmsdemo.com"), 10, 40, 120, 20)

			GUICtrlCreateLabel("Username", 140, 10, 120, 20)
			Local $hInput_RemoteUsername = GUICtrlCreateInput(IniRead($sFilePath_Settings, "Settings", "RemoteServerUsername", ""), 140, 40, 120, 20)

			GUICtrlCreateLabel("Password", 270, 10, 120, 20)
			Local $hInput_RemotePassword = GUICtrlCreateInput("", 270, 40, 120, 20, BitOR($ES_AUTOHSCROLL, $ES_PASSWORD) )

			; Set focus usefully on the first box that doesn't have a value set.
			If StringLen(GUICtrlRead($hInput_RemoteServer)) > 0 And StringLen(GUICtrlRead($hInput_RemoteUsername)) > 0 Then
				GUICtrlSetState($hInput_RemotePassword, $GUI_FOCUS)
			ElseIf StringLen(GuiCtrlRead($hInput_RemoteServer)) > 0 Then
				GUICtrlSetState($hInput_RemoteUsername, $GUI_FOCUS)
			EndIf

			Local $hBtn_RemoteServerConnect = GUICtrlCreateButton("Get Labels", 400, 40, 70, 20, $BS_DEFPUSHBUTTON)

			Local $hListView_RemoteLabels = GUICtrlCreateListView("Label",10,70,460,160, -1, $LVS_EX_CHECKBOXES )
			_GUICtrlListView_SetColumnWidth($hListView_RemoteLabels, 0, $LVSCW_AUTOSIZE_USEHEADER)

			Local $hBtn_DownloadRemoteLabels = GUICtrlCreateButton("Load selected labels", 10, 240, 160, 20)

			GUISetState(@SW_SHOW, $hGui_RemoteLabels)

			While 1
				Switch GUIGetMsg()
					Case $GUI_EVENT_CLOSE
						ExitLoop
					Case $hBtn_RemoteServerConnect
						_GUICtrlListView_DeleteAllItems($hListView_RemoteLabels)
						$sDomain = StringRegExpReplace(GUICtrlRead($hInput_RemoteServer), "http[s]?:\/\/", "");"rockrmsdemo.com"
						GUICtrlSetData($hInput_RemoteServer, $sDomain)
						$sRockUsername = GUICtrlRead($hInput_RemoteUsername);"Admin"
						$sRockPassword = GUICtrlRead($hInput_RemotePassword);"admin"

						; Store Server and Username for next time
						IniWrite($sFilePath_Settings, "Settings", "RemoteServer", $sDomain)
						IniWrite($sFilePath_Settings, "Settings", "RemoteServerUsername", $sRockUsername)

						$hw_open = _WinHttpOpen("PrintBlanks/3.0"); Used by httpRequest() also to persist the auth cookie

						; Set Rock Cookie
						$sLoginResult = httpRequest($sDomain,"/api/Auth/Login","POST",'{"Username": "' & $sRockUsername & '", "Password": "' & $sRockPassword & '"}',"application/json")

						If StringRegExp($sHttpReturnHeaders, "Server: cloudflare") And $sLoginResult <> '' Then
							MsgBox(16, "Error", "If you're using Cloudflare, you may need to allow requests to the /api/Auth/Login and /api/BinaryFiles endpoints")
							ContinueLoop
						EndIf

						If $sLoginResult <> '' Then
							$sLoginResult = Json_Decode($sLoginResult)
							MsgBox(16, "Error", Json_ObjGet($sLoginResult, "Message"))
							GUICtrlSetState($hInput_RemotePassword, $GUI_FOCUS)
							ContinueLoop
						EndIf

						; Get Check-in Labels
						$sReturned = httpRequest($sDomain,  "/api/BinaryFiles?" & _
															"$filter=BinaryFileTypeId%20eq%201&" & _
															"$select=FileName,Path" _
												)

						; This JSON library doesn't seem to work with anonymous lists, so put it in an object and give it the key "Files"
						$oJson = Json_Decode("{""Files"":" & $sReturned & "}")
						$aRemoteFileList = Json_ObjGet($oJson, "Files")

						; Make sure that at least one file was found on the server.
						If UBound($aRemoteFileList) = 0 Then
							MsgBox(16, "Error", "No Labels Found")
							ContinueLoop
						EndIf

						; Go through the list of labels and load them into the array and popup list.
						Local $aRemoteFiles[0][3]
						For $file in $aRemoteFileList
							$sLabelName = Json_ObjGet($file, "FileName")
							$sLabelPath = Json_ObjGet($file, "Path")
							If(StringLeft($sLabelPath, 1) == "~") Then $sLabelPath = StringTrimLeft($sLabelPath, 1)
							_ArrayAdd($aRemoteFiles, GUICtrlCreateListViewItem($sLabelName,$hListView_RemoteLabels) & "|" & $sLabelName & "|" & $sLabelPath)
						Next

					Case $hBtn_DownloadRemoteLabels
						; Go through the list of labels. For each one that's checked, add it to the main list and master $aLabels array.
						For $remoteFileIndex=0 To UBound($aRemoteFiles)-1
							If BitOR(GUICtrlRead($aRemoteFiles[$remoteFileIndex][0], 1), $GUI_CHECKED) = $GUI_CHECKED Then
								; The labels don't seem to need authentication, but just in case someone does secure them the cookie might get us in.
								$sLabelContents = httpRequest($sDomain, $aRemoteFiles[$remoteFileIndex][2])
								$sLabelName = $aRemoteFiles[$remoteFileIndex][1]
								$sLabelContents = StringReplace($sLabelContents, @CR, "")
								_ArrayAdd($aLabels,GUICtrlCreateListViewItem($sLabelName,$hListview_Labels) & "|" & $sLabelName & "|" & $sLabelContents & "|" & DefaultMergeFieldJSON($sLabelContents))
								SaveLabelConfig()
							EndIf
						Next

						_WinHttpCloseHandle($hw_open)
						ExitLoop

				EndSwitch
			WEnd

			GUIDelete($hGui_RemoteLabels)

		Case $hBtn_LoadBlank
			$sLabelName = InputBox("Label Name", "Enter the name of the blank label")
			If @error Then ContinueLoop
			; Strictly speaking just a blank string would work here. But let's at least give them something to work with so it looks like it did something.
			_ArrayAdd($aLabels, GUICtrlCreateListViewItem($sLabelName, $hListview_Labels) & '|' & $sLabelName & '|CT~~CD,~CC^~CT~' & @LF & '^XA' & @LF&@LF& '^XZ|{"Fields": []}')
			SaveLabelConfig()

		Case $hBtn_LoadLocal
			$hLocalLabelFile = FileOpenDialog("Select label file", @WorkingDir, "Label Files (*.prn;*.zpl)|All Files (*.*)")
			If @error Then ContinueLoop

			; To get the file name, first get everything to the right of the last backslash
			$sPresumedLabelName = StringRight($hLocalLabelFile, StringLen($hLocalLabelFile)-StringInStr($hLocalLabelFile, "\", 0, -1))
			; Now get everything left of the last period
			$sPresumedLabelName = StringLeft($sPresumedLabelName, StringInStr($sPresumedLabelName, ".", 0, -1)-1)

			$sLocalLabelName = InputBox("Label Name", "Provide a name for this label", $sPresumedLabelName)
			If @error Then ContinueLoop

			;We have the name of the label now, so load it into the list and array.
			Local $sLocalLabelContents = StringReplace(FileRead($hLocalLabelFile), @CRLF, @LF)
			_ArrayAdd($aLabels, GUICtrlCreateListViewItem($sLocalLabelName, $hListview_Labels) & "|" & $sLocalLabelName & "|" & $sLocalLabelContents & "|" & DefaultMergeFieldJSON($sLocalLabelContents) )
			SaveLabelConfig()

		Case $hBtn_UpdateCode
			; Update $aLabels[$iSelectedLabel][2] with GUICtrlRead($hInput_LabelCode)
			$aLabels[$iSelectedLabel][2] = StringReplace(GUICtrlRead($hInput_LabelCode), @CR, "")
			$aLabels[$iSelectedLabel][3] = DefaultMergeFieldJSON($aLabels[$iSelectedLabel][2], $aLabels[$iSelectedLabel][3])
			; Now save them a click and reload the merge fields and preview.
			LabelClicked($iSelectedLabel)

		Case $hBtn_RemoveLabel
			; Don't use the global $iSelectedLabel variable here; let's make sure that we only delete the label that's ACTUALLY selected...
			For $iSelectedLabelIndex=0 To UBound($aLabels)-1
				If GUICtrlRead($hListview_Labels) == $aLabels[$iSelectedLabelIndex][0] Then
					GUICtrlDelete($aLabels[$iSelectedLabelIndex][0])
					_ArrayDelete($aLabels, $iSelectedLabelIndex)
					SaveLabelConfig()
					GUICtrlSetData($hInput_LabelCode, "")
					If $hGui_ScrollingMergeFields <> "" Then GUIDelete($hGui_ScrollingMergeFields)
					GUICtrlSetImage($hPreview, "")
					FileDelete(@TempDir & "/labelPreview.png")
					ExitLoop
				EndIf
			Next
		Case $hRadio_RandomCode
			GUICtrlSetState($hInput_CodeStart, $GUI_DISABLE)
			IniWrite($sFilePath_Settings, "Settings", "CodeType", "Random")

		Case $hRadio_SequentialCode
			GUICtrlSetState($hInput_CodeStart, $GUI_ENABLE)
			IniWrite($sFilePath_Settings, "Settings", "CodeType", "Sequential")

		Case $hRadio_IPPrinter
			IniWrite($sFilePath_Settings, "Settings", "PrinterType", "IP")
			GUICtrlSetState($hInput_PrinterUNC, $GUI_DISABLE)
			GUICtrlSetState($hInput_PrinterIP, $GUI_ENABLE)

		Case $hRadio_SharePrinter
			IniWrite($sFilePath_Settings, "Settings", "PrinterType", "UNC")
			GUICtrlSetState($hInput_PrinterUNC, $GUI_ENABLE)
			GUICtrlSetState($hInput_PrinterIP, $GUI_DISABLE)

		Case $hBtn_Print
			; Determine printer type
			If GUICtrlRead($hRadio_IPPrinter) == $GUI_CHECKED Then
				$sPrinterType = "IP"
			ElseIf GUICtrlRead($hRadio_SharePrinter) == $GUI_CHECKED Then
				$sPrinterType = "Share"
			EndIf

			; Set up the infrastructure we need, depending on the printer type.
			If $sPrinterType == "IP" Then
				TCPStartup()
				$hSocket = TCPConnect(GUICtrlRead($hInput_PrinterIP), 9100)
				If @error Then
					MsgBox(16,"Error","Unable to connect to printer")
					ContinueLoop
				EndIf
			ElseIf $sPrinterType == "Share" Then
				$hPrintFile = FileOpen(@TempDir & "\printthis.txt", 2)
				If $hPrintFile = -1 Then
					MsgBox(16, "Error", "Error writing to the temp file.")
					ContinueLoop
				EndIf
			EndIf

			;Determine security code type
			If GUICtrlRead($hRadio_RandomCode) == $GUI_CHECKED Then
				$sCodeType = "Random"
			ElseIf GUICtrlRead($hRadio_SequentialCode) == $GUI_CHECKED Then
				$sCodeType = "Sequential"
			EndIf

			; Pre-set the code in case we're using a sequential system
			$sCode = GUICtrlRead($hInput_CodeStart)-1

			;Print the labels
			For $iCopy = 1 To GUICtrlRead($hInput_PrintCopies)

				;Create the code for this set of labels
				If $sCodeType == "Random" Then
					$sCode = ""
					For $l=1 To GUICtrlRead($hInput_CodeLength)
						$sCode = $sCode & RandAlphaNum()
					Next
				ElseIf $sCodeType == "Sequential" Then
					$sCode += 1
					$sCode = Pad($sCode)
					IniWrite($sFilePath_Settings, "Settings", "SequentialCodeStart", Int($sCode))
					GUICtrlSetData($hInput_CodeStart, $sCode + 1)
				EndIf

				; For each label, add it to the file or send the traffic.
				For $printingLabelIndex = 0 To UBound($aLabels)-1
					If $sPrinterType == "IP" Then
						TCPSend($hSocket, getProcessedZpl($aLabels[$printingLabelIndex][2], $aLabels[$printingLabelIndex][3], GUICtrlRead($hInput_CodePrefix) & $sCode))
					ElseIf $sPrinterType == "Share" Then
						FileWrite($hPrintFile, getProcessedZpl($aLabels[$printingLabelIndex][2], $aLabels[$printingLabelIndex][3], GUICtrlRead($hInput_CodePrefix) & $sCode))
					EndIf
				Next
			Next

			; Done printing. Now clean up.
			If $sPrinterType == "Share" Then
				FileClose($hPrintFile)
				RunWait(@comspec & ' /c copy /b "' & @TempDir & "\printthis.txt" & '" "' & GUICtrlRead($hInput_PrinterUNC) & '"', @scriptdir, @SW_HIDE)
				FileDelete(@TempDir & "\printthis.txt")
			ElseIf $sPrinterType == "IP" Then
				TCPCloseSocket($hSocket)
				TCPShutdown()
			EndIf

		Case $hCheckbox_ShowAllFields
			IniWrite($sFilePath_Settings, "Settings", "PreviewAllFields", GUICtrlRead($hCheckbox_ShowAllFields))

		Case $hBtn_ReloadPreview
			If $iSelectedLabel >= 0 Then
				LoadPreviewImage($aLabels[$iSelectedLabel][2], $aLabels[$iSelectedLabel][3])
			EndIf

		Case Else; one of the dynamically-built controls (Label, Merge Field)

			For $iSelectedLabelIndex = 0 To UBound($aLabels)-1; Check to see if a label was clicked
				If $msg = $aLabels[$iSelectedLabelIndex][0] Then; A label was clicked
					$iSelectedLabel = $iSelectedLabelIndex
					LabelClicked($iSelectedLabel)
					ExitLoop
				EndIf
			Next

			For $iMergeFieldIndex=0 To UBound($aMergeFieldControls)-1; Check to see if a merge field control was clicked (not including changes to the input boxes; that's handled by GUICtrlonchangeRegister() )
				If $msg = $aMergeFieldControls[$iMergeFieldIndex][2] Or $msg = $aMergeFieldControls[$iMergeFieldIndex][3] Then; Hide or Security Code options chosen

					GUICtrlSetState($aMergeFieldControls[$iMergeFieldIndex][5], $GUI_DISABLE)

					;Update merge field settings JSON string
					$sExistingJson = $aLabels[$iSelectedLabel][3]
					$aExistingSettings = StringRegExp($sExistingJson, '(?i){"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "(.*?)","FieldText": "(.*?)"}', 3)

					If UBound($aExistingSettings) <> 2 Then
						MsgBox(16, "Error", "Something went wrong changing the merge field settings (1)")
						ExitLoop
					EndIf
					$sExistingControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "' & $aExistingSettings[0] & '","FieldText": "' & $aExistingSettings[1] & '"}'
					$sNewControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "'
					If GUICtrlRead($aMergeFieldControls[$iMergeFieldIndex][2]) == $GUI_CHECKED Then
						$sNewControlSettings &= "Hide"
					ElseIf GUICtrlRead($aMergeFieldControls[$iMergeFieldIndex][3]) == $GUI_CHECKED Then
						$sNewControlSettings &= "Code"
					EndIf

					$sNewControlSettings &= '","FieldText": "' & GUICtrlRead($aMergeFieldControls[$iMergeFieldIndex][5]) & '"}'
					$aLabels[$iSelectedLabel][3] = StringReplace($aLabels[$iSelectedLabel][3], $sExistingControlSettings, $sNewControlSettings)
					SaveLabelConfig()
					ExitLoop

				ElseIf $msg = $aMergeFieldControls[$iMergeFieldIndex][4] Then; Static Text option chosen

					GUICtrlSetState($aMergeFieldControls[$iMergeFieldIndex][5], $GUI_ENABLE)
					;Update merge field settings JSON string
					$sExistingJson = $aLabels[$iSelectedLabel][3]
					$aExistingSettings = StringRegExp($sExistingJson, '(?i){"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "(.*?)","FieldText": "(.*?)"}', 3)

					If UBound($aExistingSettings) <> 2 Then
						MsgBox(16, "Error", "Something went wrong changing the merge field settings (2)")
						ExitLoop
					EndIf
					$sExistingControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "' & $aExistingSettings[0] & '","FieldText": "' & $aExistingSettings[1] & '"}'
					$sNewControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "Text","FieldText": "' & GUICtrlRead($aMergeFieldControls[$iMergeFieldIndex][5]) & '"}'
					$aLabels[$iSelectedLabel][3] = StringReplace($aLabels[$iSelectedLabel][3], $sExistingControlSettings, $sNewControlSettings)
					SaveLabelConfig()
					ExitLoop

				EndIf
			Next

	EndSwitch
WEnd


Func httpRequest($sDomain, $sEndpoint, $sMethod="GET", $sContent="", $sContentType = "application/json", $iMode=Default)

	Local $hw_connect = _WinHttpConnect($hw_open, $sDomain)
	Local $h_openRequest = _WinHttpOpenRequest($hw_connect, $sMethod, $sEndpoint)

	_WinHttpSendRequest($h_openRequest, "Content-Type: " & $sContentType, $sContent)
	_WinHttpReceiveResponse($h_openRequest)

	; Store what's returned
	Local $sReturned
	If _WinHttpQueryDataAvailable($h_openRequest) Then ; if there is data
		If $iMode = 2 Then
			While 1
				$bChunk = _WinHttpReadData($h_openRequest, $iMode)
				If @error Then ExitLoop
				$sReturned = _WinHttpSimpleBinaryConcat($sReturned, $bChunk)
			WEnd
		Else
			Do
				$sReturned &= _WinHttpReadData($h_openRequest)
			Until @error
		EndIf
	EndIf

	; Set a global variable so we can check the headers if needed
	Global $sHttpReturnHeaders = _WinHttpQueryHeaders($h_openRequest)

	_WinHttpCloseHandle($h_openRequest)
	_WinHttpCloseHandle($hw_connect)

	Return $sReturned
EndFunc

Func _StringTruncateWords( $sText, $iWordCount )
	Local $nthSpace = StringInStr($sText, " ", 0, $iWordCount)
	If $nthSpace > 0 Then
		Return StringLeft($sText, $nthSpace-1) & "..."
	Else
		Return $sText
	EndIf
EndFunc

Func InitializeMergeFieldControlsArray()
	Global $aMergeFieldControls[0][6]
EndFunc

Func DefaultMergeFieldJSON($sLabelContent, $sExistingJson="" )
	Local $aMergeFields = StringRegExp($sLabelContent, "(?i)\^FD(.*?)\^FS", 3)

	; Return format: {"Fields": [{"FieldCode": "WWW", "FieldShow": "Code", "FieldText", ""},{"FieldCode": "1", "FieldShow": "Hide", "FieldText": ""}]}
	Local $sReturnString = '{"Fields": ['

	; Load the existing JSON so we can keep any merge fields that were already configured.
	If StringLen($sExistingJson) > 0 Then
		Local $oExistingMergeFields = JSON_Decode($sExistingJson)
		Local $aExistingMergeFields = JSON_ObjGet($oExistingMergeFields, "Fields")
	EndIf

	For $iFieldNumber=0 To UBound($aMergeFields)-1

		;Escape and store this merge field (removing all line break characters when evaluating the code)
		$sEscapedMergeField = StringReplace(StringReplace(StringReplace($aMergeFields[$iFieldNumber], '"', '\"'), @CR, ""), @LF, "")

		; First add the comma after the last element in the JSON string, if one exists (detect the closing "}")
		If StringRight($sReturnString, 1) == "}" Then $sReturnString &= ","

		; Loop through the existing merge fields to find a match. If one's found then use the same settings.
		Local $bMatchingFieldFound = 0
		If StringLen($sExistingJson) > 0 Then
			For $field in $aExistingMergeFields
				If Json_ObjGet($field, "FieldCode") == $sEscapedMergeField Then
					$bMatchingFieldFound = 1
					$sReturnString &=	'{"FieldCode": "' & $sEscapedMergeField & '",' & _
										'"FieldShow": "' & Json_ObjGet($field, "FieldShow") & '",' & _
										'"FieldText": "' & Json_ObjGet($field, "FieldText") & '"}'
					ExitLoop
				EndIf
			Next
		EndIf

		; If no match was found then use default logic to set the merge field settings.
		If $bMatchingFieldFound == 0 Then
			If($sEscapedMergeField == "WWW") Then
				; A common pattern in Rock labels is that WWW is the security code. Default as such.
				$sReturnString &= 	'{"FieldCode": "' & $sEscapedMergeField & '",' & _
									'"FieldShow": "Code",' & _
									'"FieldText": "' & $sEscapedMergeField & '"}'
			ElseIf(StringLen($sEscapedMergeField) > 3) Then
				; Assume long merge fields are static text that should show.
				$sReturnString &= 	'{"FieldCode": "' & $sEscapedMergeField & '",' & _
									'"FieldShow": "Text",' & _
									'"FieldText": "' & $sEscapedMergeField & '"}'
			Else
				; For short merge fields, default to "Hide".
				$sReturnString &= 	'{"FieldCode": "' & $sEscapedMergeField & '",' & _
									'"FieldShow": "Hide",' & _
									'"FieldText": "' & $sEscapedMergeField & '"}'
			EndIf
		EndIf
	Next
	Return $sReturnString & ']}'
EndFunc

Func LabelClicked( $arrayIndex )
	; Show the ZPL in the edit window. But many labels only use @LF, so collapse all @CRLF to @LF to catch outliers, and then expand ALL @LF to @CRLF so the code shows nicely in the edit control.
	GUICtrlSetData($hInput_LabelCode,StringReplace(StringReplace($aLabels[$arrayIndex][2],@CRLF,@LF),@LF,@CRLF))

	; Declare $aMergeFieldControls (use a function so there's one master copy of the array size).
	InitializeMergeFieldControlsArray()

	Local $oMergeFields = JSON_Decode($aLabels[$arrayIndex][3])
	Local $aMergeFields = JSON_ObjGet($oMergeFields, "Fields")

	If $hGui_ScrollingMergeFields <> "" Then GUIDelete($hGui_ScrollingMergeFields)
	$hGui_ScrollingMergeFields = GUICreate("", 406, 245, 439, 180, BitOR($WS_POPUP, $WS_BORDER), $WS_EX_MDICHILD, $hGUI)
	GUISetBkColor(0xFFFFFF, $hGui_ScrollingMergeFields)

	For $field in $aMergeFields
		$fieldCode = Json_ObjGet($field, "FieldCode")
		$fieldShow = Json_ObjGet($field, "FieldShow")
		$fieldText = Json_ObjGet($field, "FieldText")
		Local $latestControlIndex = UBound($aMergeFieldControls)
		_ArrayAdd($aMergeFieldControls,	$fieldCode & "|" & _																								;Element 0: Merge Field Text
										GUICtrlCreateGroup(_StringTruncateWords($fieldCode,6), 10, 10+($latestControlIndex*60), 360, 45) & "|" & _			;Element 1: Handle of Group
										GUICtrlCreateRadio("Hide", 20, 25+($latestControlIndex*60), 40, 20, $GUI_CHECKED) & "|" & _							;Element 2: Handle of "Hide" option
										GUICtrlCreateRadio("Security Code", 70, 25+($latestControlIndex*60), 85, 20) & "|" & _								;Element 3: Handle of "Code" option
										GUICtrlCreateRadio("Text:", 165, 25+($latestControlIndex*60), 40, 20) & "|" & _										;Element 4: Handle of "Text" option
										GUICtrlCreateInput($fieldText, 208, 25+($latestControlIndex*60), 150, 20) )											;Element 5: Handle of Text input box
		GUICtrlonchangeRegister($aMergeFieldControls[$latestControlIndex][5], "UpdateMergeFieldText", $aMergeFieldControls[$latestControlIndex][5])

		Switch $fieldShow
			Case "Hide"
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][2], $GUI_CHECKED)
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][5], $GUI_DISABLE)
			Case "Code"
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][3], $GUI_CHECKED)
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][5], $GUI_DISABLE)
			Case "Text"
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][4], $GUI_CHECKED)
				GUICtrlSetState($aMergeFieldControls[$latestControlIndex][5], $GUI_ENABLE)
		EndSwitch
	Next
	_GUIScrollbars_Generate($hGui_ScrollingMergeFields, 0, 60*UBound($aMergeFieldControls) )
	GUISetState(@SW_SHOW, $hGui_ScrollingMergeFields)

	If(StringLen($aLabels[$arrayIndex][2]) > 0) Then
		LoadPreviewImage($aLabels[$arrayIndex][2], $aLabels[$arrayIndex][3])
	Else ; a blank label was selected
		GUICtrlSetImage($hPreview, "")
	EndIf
EndFunc

Func UpdateMergeFieldText( $hCtl )
	For $iMergeFieldIndex=0 To UBound($aMergeFieldControls)-1
		If $hCtl = $aMergeFieldControls[$iMergeFieldIndex][5] Then

			$sExistingJson = $aLabels[$iSelectedLabel][3]
			$aExistingSettings = StringRegExp($sExistingJson, '(?i){"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "(.*?)","FieldText": "(.*?)"}', 3)

			If UBound($aExistingSettings) <> 2 Then
				MsgBox(16, "Error", "Something went wrong changing the merge field settings (3)")
				Return
			EndIf
			$sExistingControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "' & $aExistingSettings[0] & '","FieldText": "' & $aExistingSettings[1] & '"}'
			$sNewControlSettings = '{"FieldCode": "' & $aMergeFieldControls[$iMergeFieldIndex][0] & '","FieldShow": "' & $aExistingSettings[0] & '","FieldText": "' & GUICtrlRead($aMergeFieldControls[$iMergeFieldIndex][5]) & '"}'
			$aLabels[$iSelectedLabel][3] = StringReplace($aLabels[$iSelectedLabel][3], $sExistingControlSettings, $sNewControlSettings)
			Return

		EndIf
	Next
EndFunc

Func UpdateCodePrefix()
	IniWrite($sFilePath_Settings, "Settings", "CodePrefix", GUICtrlRead($hInput_CodePrefix))
EndFunc

Func UpdateCodeLength()
	If GUICtrlRead($hInput_CodeLength) > 0 And GUICtrlRead($hInput_CodeLength) < 7 Then
		IniWrite($sFilePath_Settings, "Settings", "CodeLength", GUICtrlRead($hInput_CodeLength))
	Else
		GUICtrlSetData($hInput_CodeLength, "1")
		IniWrite($sFilePath_Settings, "Settings", "CodeLength", "1")
	EndIf
EndFunc

Func UpdateSequentialCodeStart()
	If StringIsInt(GUICtrlRead($hInput_CodeStart)) AND GUICtrlRead($hInput_CodeStart) >= 0 Then
		IniWrite($sFilePath_Settings, "Settings", "SequentialCodeStart", GUICtrlRead($hInput_CodeStart))
	Else
		GUICtrlSetData($hInput_CodeStart, "0")
		IniWrite($sFilePath_Settings, "Settings", "SequentialCodeStart", "0")
	EndIf
EndFunc

Func UpdatePrinterIP()
	IniWrite($sFilePath_Settings, "Settings", "PrinterIP", GUICtrlRead($hInput_PrinterIP))
EndFunc

Func UpdatePrinterUNC()
	IniWrite($sFilePath_Settings, "Settings", "PrinterUNC", GUICtrlRead($hInput_PrinterUNC))
EndFunc

Func UpdatePrintCopies()
	If Not (GUICtrlRead($hInput_PrintCopies) > 0 And StringIsInt(GUICtrlRead($hInput_PrintCopies)) ) Then
		GUICtrlSetData($hInput_PrintCopies, 1)
	EndIf
EndFunc

Func RandAlphaNum()
	Local $rand = Round(Random(48,83))
	If $rand > 57 Then $rand = $rand + 7
	Return Chr($rand)
EndFunc

Func Pad($sCode)
	Local $needed = GUICtrlRead($hInput_CodeLength) - StringLen($sCode)
	For $_n = 1 To $needed
		$sCode = "0" & $sCode
	Next
	Return StringRight($sCode, GUICtrlRead($hInput_CodeLength))
EndFunc

Func LoadPreviewImage( $sZPL, $sMergeJson="{}")
	GUICtrlSetImage($hPreview, "")
	FileDelete(@TempDir & "\labelPreview.png")

	If Not _GDIPlus_Startup() Or @extended < 6 Then
		Return
	EndIf

	;Check and make sure we can reach labelary.com
	Local $iPingTime = Ping("labelary.com")
	If @error Then
		If GUICtrlRead($hBtn_ReloadPreview) == "Reload Preview" Then
			MsgBox(16, "Offline", "We don't seem to be able to reach labelary.com to generate the preview. Other functions will still work though")
			GUICtrlSetState($hBtn_ReloadPreview, $GUI_DISABLE)
		EndIf
		_GDIPlus_Shutdown()
		GUICtrlSetData($hBtn_ReloadPreview, "(offline)")
		Return
	EndIf
	If GUICtrlRead($hBtn_ReloadPreview) == "(offline)" Then
		GUICtrlSetData($hBtn_ReloadPreview, "Reload Preview")
		GUICtrlSetState($hBtn_ReloadPreview, $GUI_ENABLE)
	EndIf


	; download the preview label from Labelary API to temp dir

	; NOTE: I removed the _URIEncode function I originally used in the commented command below since I'm not using it any more.
	; It was posted by Prog@ndy in the forums but I had to modify it slightly because it was sending + for space instead of %20.
	; I'm using a POST request now to the labelary api so we can send lots more label data and it works really well.
	;InetGet("https://api.labelary.com/v1/printers/8dpmm/labels/4x2/0/" & _URIEncode($aLabels[$arrayIndex][2]),@TempDir & "/labelPreview.png")

	Global $hw_open = _WinHttpOpen("PrintBlanks/3.0")
	If GUICtrlRead($hCheckbox_ShowAllFields) == $GUI_CHECKED Then
		$previewFile = httpRequest("api.labelary.com", "/v1/printers/8dpmm/labels/4x2/0", "POST", $DefaultIconFont & $sZpl, "application/x-www-form-urlencoded", 2)
	Else
		$previewFile = httpRequest("api.labelary.com", "/v1/printers/8dpmm/labels/4x2/0", "POST", $DefaultIconFont & getProcessedZpl($sZpl, $sMergeJson, "GSF"), "application/x-www-form-urlencoded", 2)
	EndIf

	; Store the returned data as a png
	_WinHttpCloseHandle($hw_open)
	$h_previewFile = FileOpen(@TempDir & "\labelPreview.png", 18)
	FileWrite($h_previewFile, $previewFile)
	FileClose($h_previewFile)

	; Show the png we just stored
	$hImage = _GDIPlus_ImageLoadFromFile(@TempDir & "\labelPreview.png")
	$hImage_resized = _GDIPlus_ImageResize($hImage, 406, 203)
	$hBitmap = _GDIPlus_BitmapCreateHBITMAPFromBitmap($hImage_resized)
	GUICtrlSendMsg($hPreview, 0x0172, 0, $hBitmap); STM_SETIMAGE = 0x0172, $arrayIndexMAGE_BITMAP = 0

	_GDIPlus_ImageDispose($hImage)
	_GDIPlus_ImageDispose($hImage_resized)
	_GDIPlus_Shutdown()
EndFunc

Func getProcessedZpl( $sZPL, $sMergeJson, $sCode )
	; Strip out all of the line break characters. ZPL doesn't need them and so we can be more consistent and save just a little bandwidth.
	Local $processedZpl = StringReplace(StringReplace($sZPL, @CR, ""), @LF, "")

	;StringReplace all of the merge fields in the ZPL based on all of the JSON settings.
	Local $oMergeFields = JSON_Decode($sMergeJson)
	Local $aMergeFields = JSON_ObjGet($oMergeFields, "Fields")

	For $field in $aMergeFields
		$fieldCode = Json_ObjGet($field, "FieldCode")
		$fieldShow = Json_ObjGet($field, "FieldShow")
		$fieldText = Json_ObjGet($field, "FieldText")
		If $fieldShow = "Hide" Then
			$processedZpl = StringReplace($processedZpl, "^FD" & $fieldCode & "^FS", "^FD^FS")
		ElseIf $fieldShow = "Code" Then
			$processedZpl = StringReplace($processedZpl, "^FD" & $fieldCode & "^FS", "^FD" & $sCode & "^FS")
		ElseIf $fieldShow = "Text" Then
			$processedZpl = StringReplace($processedZpl, "^FD" & $fieldCode & "^FS", "^FD" & $fieldText & "^FS")
		EndIf
	Next
	Return $processedZpl
EndFunc

Func SaveLabelConfig()
	FileClose(FileWrite(FileOpen($sFilePath_LabelSave, 2), _ArrayToString($aLabels)))
EndFunc

Func RestoreAutoSaveLabels()
	$sRestoredLabelString = FileRead($sFilePath_LabelSave)
	If StringLen($sRestoredLabelString) > 0 Then
		$aRestoredLabels = _ArrayFromString(FileRead($sFilePath_LabelSave))
		If Not @error And UBound($aRestoredLabels) > 0 Then
			For $restoreLabelIndex = 0 To UBound($aRestoredLabels)-1
				_ArrayAdd($aLabels,GUICtrlCreateListViewItem($aRestoredLabels[$restoreLabelIndex][1], $hListview_Labels) & "|" & $aRestoredLabels[$restoreLabelIndex][1] & "|" & $aRestoredLabels[$restoreLabelIndex][2] & "|" & $aRestoredLabels[$restoreLabelIndex][3])
			Next
		EndIf
	EndIf
EndFunc

Func ExitNow()
	GUIDelete()
	FileDelete(@TempDir & "/labelPreview.png")
	Exit
EndFunc